<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Manager (Compact UI)</title>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f4f6f8; 
      margin: 0; 
      padding: 0; 
    }

    .container { 
      max-width: 1100px; 
      margin: auto; 
      padding: 30px; 
    }

    h1 { 
      margin-bottom: 25px; 
      font-size: 28px; 
      font-weight: bold; 
    }

    .box { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      margin-bottom: 25px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    }

    /* Compact layout */
    .row { 
      display: flex; 
      gap: 15px; 
      margin-bottom: 20px; 
      flex-wrap: wrap;
    }

    .row select { 
      padding: 10px; 
      border-radius: 6px; 
      border: 1px solid #ccc; 
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px; 
    }

    th, td { 
      padding: 12px; 
      border-bottom: 1px solid #ddd; 
      text-align: left; 
    }

    th { 
      background: #eef1f4; 
      font-weight: bold;
    }

    input.amount-input { 
      width: 120px; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
    }

    .btn { 
      padding: 8px 12px; 
      background: #0275d8; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 13px; 
    }

    .btn:hover { background: #025aa5; }

    .accordion { 
      cursor: pointer; 
      padding: 12px; 
      background: #ddd; 
      border-radius: 6px; 
      margin-top: 10px; 
      font-weight: bold; 
      user-select: none;
    }

    .accordion-content { 
      display: none; 
      background: #fafafa; 
      padding: 12px; 
      border-radius: 6px; 
      margin-top: 5px; 
    }

    input, select { 
      width: 100%; 
      padding: 10px; 
      border-radius: 6px; 
      border: 1px solid #ccc; 
      margin-top: 8px; 
      margin-bottom: 12px; 
    }
  </style>
</head>

<body>
<div class="container">
  
  <h1>Property Manager</h1>

  <!-- Property Selector -->
  <div class="box">
    <h3>Select Property</h3>
    <select id="propertyDropdown" onchange="selectPropertyFromDropdown()"></select>
  </div>

  <!-- Month Selector -->
  <div class="box" id="monthSection" style="display:none;">
    <h3>Month / Year</h3>

    <div class="row">
      <select id="monthSelect">
        <option value="1">Jan</option><option value="2">Feb</option>
        <option value="3">Mar</option><option value="4">Apr</option>
        <option value="5">May</option><option value="6">Jun</option>
        <option value="7">Jul</option><option value="8">Aug</option>
        <option value="9">Sep</option><option value="10">Oct</option>
        <option value="11">Nov</option><option value="12">Dec</option>
      </select>

      <select id="yearSelect"></select>

      <button class="btn" onclick="loadMonthlyRecords()">Load</button>
      
    </div>

    <div id="monthlyTableSection"></div>
  </div>

  <!-- Add Property (Collapsible) -->
  <div class="accordion" onclick="toggleAccordion('propAcc')">+ Add Property</div>
  <div id="propAcc" class="accordion-content">
    <input id="propertyName" placeholder="Property Name">
    <button class="btn" onclick="addProperty()">Add</button>
  </div>

  <!-- Add Tenant (Collapsible) -->
  <div class="accordion" onclick="toggleAccordion('tenantAcc')">+ Add Tenant</div>
  <div id="tenantAcc" class="accordion-content">
    <input id="tenantName" placeholder="Tenant Name">
    <input id="tenantRent" type="number" placeholder="Rent Amount">
    <select id="electricityCycle">
      <option value="1">Electricity every 1 month</option>
      <option value="2">Every 2 months</option>
      <option value="3">Every 3 months</option>
    </select>
    <button class="btn" onclick="addTenant()">Add Tenant</button>
  </div>

</div>

<script>
let selectedProperty = null;

/* Toggle Accordion */
function toggleAccordion(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}

/* Load Years */
(function loadYears() {
  const y = new Date().getFullYear();
  let html = "";
  for (let yr = y - 2; yr <= y + 3; yr++)
    html += `<option value='${yr}'>${yr}</option>`;
  document.getElementById("yearSelect").innerHTML = html;
})();

/* Load Properties into dropdown */
async function loadProperties() {
  const res = await fetch("/api/getProperties");
  const props = await res.json();

  let html = `<option value=''>Select</option>`;
  props.forEach(
    (p) => (html += `<option value='${p._id}'>${p.name}</option>`)
  );

  document.getElementById("propertyDropdown").innerHTML = html;
}

/* When property selected */
async function selectPropertyFromDropdown() {
  selectedProperty = document.getElementById("propertyDropdown").value;
  if (!selectedProperty) return;

  document.getElementById("monthSection").style.display = "block";
}

/* Add Property */
async function addProperty() {
  const name = document.getElementById("propertyName").value.trim();
  if (!name) return alert("Enter name");

  await fetch("/api/addProperty", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name }),
  });

  loadProperties();
  document.getElementById("propertyName").value = "";
}

/* Add Tenant */
async function addTenant() {
  const name = document.getElementById("tenantName").value;
  const rent = document.getElementById("tenantRent").value;
  const cycle = document.getElementById("electricityCycle").value;

  if (!selectedProperty) return alert("Select property first");

  await fetch("/api/addTenant", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      propertyId: selectedProperty,
      name,
      rentAmount: rent,
      electricityBillMonthCycle: cycle,
    }),
  });

  document.getElementById("tenantName").value = "";
  document.getElementById("tenantRent").value = "";
}

/* Create ALL records for month */
async function createAllRecords() {
  const month = Number(document.getElementById("monthSelect").value);
  const year = Number(document.getElementById("yearSelect").value);

  await fetch("/api/addMonthlyRecordBatch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ propertyId: selectedProperty, month, year }),
  });

  loadMonthlyRecords();
}

/* Load Monthly Records (table view) */
async function loadMonthlyRecords() {
  const month = Number(document.getElementById("monthSelect").value);
  const year = Number(document.getElementById("yearSelect").value);

  const res = await fetch(
    `/api/getMonthlyRecords?propertyId=${selectedProperty}&month=${month}&year=${year}`
  );
  const list = await res.json();

  let html = `
    <table>
      <tr>
        <th>Tenant</th>
        <th>Rent</th>
        <th>Amount Received</th>
        <th>Status</th>
        <th>Update</th>
      </tr>`;

  list.forEach((r) => {
    let status = "Not Received";
    if (r.amountReceived >= r.rentAmount) status = "Full";
    else if (r.amountReceived > 0) status = "Partial";

    html += `
      <tr>
        <td>${r.tenantName}</td>
        <td>â‚¹${r.rentAmount}</td>
        <td><input class='amount-input' id='amt_${r._id}' value='${
      r.amountReceived || 0
    }'></td>
        <td>${status}</td>
        <td><button class='btn' onclick="updateAmountReceived('${
          r._id
        }','${r.rentAmount}')">Save</button></td>
      </tr>`;
  });

  html += `</table>`;

  document.getElementById("monthlyTableSection").innerHTML = html;
}

/* Update Actual Amount Received */
async function updateAmountReceived(id, rentAmount) {
  const val = Number(document.getElementById("amt_" + id).value);

  await fetch("/api/updateMonthlyRecord", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id,
      amountReceived: val,
      rentAmount: Number(rentAmount),
    }),
  });

  loadMonthlyRecords();
}

/* Initialize */
loadProperties();
</script>
</body>
</html>
